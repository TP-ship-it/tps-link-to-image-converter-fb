<!DOCTYPE html>
<html>
<head>
    <title>Image Upload</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #f6f8fc;
            --panel: #ffffff;
            --text: #111827;
            --muted: #6b7280;
            --border: #e5e7eb;
            --primary: #2563eb;
            --primary2: #1d4ed8;
            --danger: #dc2626;
            --shadow: 0 14px 40px rgba(15, 23, 42, 0.10);
            --radius: 14px;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background: radial-gradient(1200px 400px at 10% 0%, #eaf0ff 0%, transparent 60%),
                        radial-gradient(1000px 500px at 90% 10%, #e8fbf5 0%, transparent 55%),
                        var(--bg);
            color: var(--text);
            margin: 0;
            padding: 48px 16px;
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 22px;
        }

        h2 { margin: 0 0 6px; font-weight: 700; letter-spacing: 0.2px; }
        .muted { color: var(--muted); font-size: 13px; }
        .error { color: var(--danger); font-weight: 600; }

        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .hidden { display: none; }

        input, button {
            width: 100%;
            padding: 12px 12px;
            margin: 10px 0;
            box-sizing: border-box;
            border-radius: 12px;
            font-family: inherit;
            font-size: 14px;
        }

        input {
            border: 1px solid var(--border);
            background: #fff;
            outline: none;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        input:focus {
            border-color: rgba(37, 99, 235, 0.55);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.12);
        }

        button {
            border: 0;
            cursor: pointer;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary2) 100%);
            color: #fff;
            font-weight: 700;
            letter-spacing: 0.2px;
            transition: transform 0.06s ease, filter 0.15s ease;
        }

        button:disabled { opacity: 0.55; cursor: not-allowed; filter: grayscale(0.25); }
        button:active { transform: translateY(1px); }

        .danger { background: linear-gradient(135deg, #ef4444 0%, var(--danger) 100%); }

        .box {
            border: 2px dashed #cbd5e1;
            border-radius: var(--radius);
            padding: 28px;
            text-align: center;
            cursor: pointer;
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            transition: border-color 0.15s ease, box-shadow 0.15s ease, transform 0.15s ease;
        }

        .box.drag {
            border-color: rgba(37, 99, 235, 0.8);
            box-shadow: 0 0 0 6px rgba(37, 99, 235, 0.10);
            transform: translateY(-1px);
        }

        img { width: 100%; border-radius: var(--radius); border: 1px solid var(--border); }

        .result {
            margin-top: 18px;
            padding-top: 18px;
            border-top: 1px solid var(--border);
        }

        .line {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .line input { margin: 0; background: #f9fafb; }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            background: #eff6ff;
            color: #1e40af;
            font-weight: 600;
            font-size: 12px;
            border: 1px solid #dbeafe;
            margin-bottom: 12px;
        }

        .shareRowUpload {
            margin-top: 24px;
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
        }

        .shareBtnUpload {
            border-radius: 999px;
            padding: 8px 12px;
            border: 0;
            font-size: 13px;
            font-weight: 600;
            color: #fff;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .shareBtnUpload.fb { background: #1877f2; }
        .shareBtnUpload.tw { background: #1d9bf0; }
        .shareBtnUpload.in { background: #0a66c2; }

        .cardWrap {
            margin-top: 18px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            background: #fff;
        }

        .cardHeader {
            padding: 4px 0 0;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #94a3b8;
        }

        .cardImg {
            background: #020617;
            max-height: 260px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 1.91 / 1; /* Facebook card ratio */
        }

        .cardImg.square {
            aspect-ratio: 1 / 1; /* สำหรับรูปสี่เหลี่ยมจัตุรัส */
        }

        .cardImg img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: 50% 50%;
            cursor: grab;
            user-select: none;
            -webkit-user-drag: none;
        }

        .cardHint {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
        }

        .cardBody { padding: 14px; }
        .cardTitle { font-weight: 700; margin-bottom: 6px; }

        .cropper-controls-wrapper {
            margin-top: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .cropper-controls-wrapper i {
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .cropper-controls-wrapper i:hover {
            opacity: 0.7;
        }

        .cropper-controls-wrapper i.text-gray-600 {
            color: #6b7280;
            font-size: 14px;
        }

        .cropper-controls-wrapper i.text-gray-700 {
            color: #374151;
        }

        .slider-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            max-width: 400px;
        }

        .slider-wrapper input[type="range"] {
            flex: 1;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            outline: none;
            margin: 0;
            padding: 0;
            -webkit-appearance: none;
        }

        .slider-wrapper input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #2563eb;
            border-radius: 50%;
            cursor: pointer;
        }

        .slider-wrapper input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #2563eb;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        #debug {
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed #cbd5e1;
            border-radius: 12px;
            background: #f8fafc;
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chip">Image Host</div>
        <h2>ลากรูปมาวางที่นี่</h2>
        <div class="muted">ลากรูปมาวาง หรือเลือกไฟล์จากเครื่อง หรือใส่ URL รูป แล้วกด ถัดไป</div>

        <div style="margin-top:14px; display: flex; gap: 10px; margin-bottom: 10px;">
            <button type="button" id="modeSingle" class="modeBtn" style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--primary); color: #fff; cursor: pointer;">รูปเดี่ยว</button>
            <button type="button" id="modeGrid" class="modeBtn" style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: #fff; color: var(--text); cursor: pointer;">รูป Grid</button>
        </div>

        <div id="singleMode">
            <div id="drop" class="box" style="margin-top:14px;">
                ลากรูปมาวางที่นี่<br>
                <span class="muted">หรือคลิกเพื่อเลือกไฟล์</span>
            </div>
            <input id="file" type="file" accept="image/*" class="hidden">
        </div>

        <div id="gridMode" class="hidden">
            <div id="dropGrid" class="box" style="margin-top:14px;">
                ลากรูปมาวางที่นี่ (2-5 รูป)<br>
                <span class="muted">หรือคลิกเพื่อเลือกหลายไฟล์</span>
            </div>
            <input id="gridFiles" type="file" accept="image/*" class="hidden" multiple>
            <div id="gridPreview" style="margin-top: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-height: 300px; overflow-y: auto;"></div>
            <div style="margin-top: 10px;">
                <input type="text" id="gridOverlayText" placeholder="Overlay Text (เช่น +9, +5)" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border);">
            </div>
        </div>

        <!-- hidden fields: เก็บ element เดิมไว้ให้ JS / backend ใช้งาน แต่ไม่แสดงให้ผู้ใช้ -->
        <input id="title" type="hidden" value="">
        <input id="description" type="hidden" value="">
        <input id="expiry" type="hidden" value="">

        <div class="row" style="margin-top:14px;">
            <div></div>
            <button id="uploadBtn" type="button" disabled>ถัดไป</button>
        </div>

        <div id="status" class="muted"></div>
        <div id="err" class="error"></div>
        <div id="debug" class="muted hidden"></div>

        <div id="previewWrap" class="hidden">
            <img id="preview" alt="">
        </div>

        <div style="margin-top:26px;">
            <div class="shareRowUpload">
                <button type="button" class="shareBtnUpload fb" title="แชร์บน Facebook (ต้องสร้างลิงก์ก่อน)">Facebook</button>
                <button type="button" class="shareBtnUpload tw" title="แชร์บน Twitter (ต้องสร้างลิงก์ก่อน)">Twitter</button>
                <button type="button" class="shareBtnUpload in" title="แชร์บน LinkedIn (ต้องสร้างลิงก์ก่อน)">LinkedIn</button>
            </div>

            <div class="cardHeader" style="margin-top:18px;">Preview</div>
            <div id="card" class="hidden cardWrap">
                <div class="cardImg">
                    <img id="cardImage" alt="">
                </div>
                <div class="cardBody">
                    <div id="cardTitle" class="cardTitle"></div>
                    <div id="cardDesc" class="muted"></div>
                    <div class="muted" style="text-transform:uppercase; font-size:12px; margin-top:6px;">{{ request.host }}</div>
                    <div class="cardHint">* ลากรูปด้านบนเพื่อเลื่อนตำแหน่งพรีวิว</div>
                </div>
            </div>

            <div class="cropper-controls-wrapper">
                <i class="fa fa-undo-alt icon icon-rotate-left rotate-ccw-btn text-gray-600 text-xs" id="rotateLeftBtn" title="Rotate Left"></i>
                <div class="slider-wrapper">
                    <i class="fa fa-image text-gray-700" style="font-size: 14px;"></i>
                    <input type="range" id="zoomSlider" min="50" max="300" value="100" step="1">
                    <i class="fa fa-lg fa-image text-gray-700"></i>
                </div>
                <i class="fa fa-redo-alt icon icon-rotate-right rotate-cw-btn text-gray-600 text-xs" id="rotateRightBtn" title="Rotate Right"></i>
            </div>
        </div>

    <div id="result" class="result hidden">
        <h3 style="margin:0 0 10px;">ลิงก์ของคุณ</h3>
        <div class="line">
            <input id="directUrl" type="text" readonly>
            <button type="button" id="copyDirect">Copy</button>
        </div>
        <div class="line">
            <input id="viewUrl" type="text" readonly>
            <button type="button" id="copyView">Copy</button>
        </div>
        <div class="line">
            <input id="deleteToken" type="text" readonly>
            <button type="button" id="copyToken">Copy</button>
        </div>
        <div class="line">
            <input id="deleteUrl" type="text" readonly>
            <button type="button" id="copyDeleteUrl">Copy</button>
        </div>
        <button type="button" id="deleteBtn" class="danger">ลบรูปนี้</button>
        <div id="deleteStatus" class="muted"></div>

        <div class="row" style="margin-top:10px;">
            <button type="button" id="nextBtn">ถัดไป &rarr;</button>
        </div>
    </div>
    </div>

    <script>
        (function () {
            var CSRF_TOKEN = "{{ csrf_token() }}";
            var drop = document.getElementById('drop');
            var fileInput = document.getElementById('file');
            var uploadBtn = document.getElementById('uploadBtn');
            var previewWrap = document.getElementById('previewWrap');
            var preview = document.getElementById('preview');
            var statusEl = document.getElementById('status');
            var errEl = document.getElementById('err');
            var expiryEl = document.getElementById('expiry');
            var titleEl = document.getElementById('title');
            var descriptionEl = document.getElementById('description');
            var resultEl = document.getElementById('result');
            var debugEl = document.getElementById('debug');

            var card = document.getElementById('card');
            var cardTitle = document.getElementById('cardTitle');
            var cardDesc = document.getElementById('cardDesc');
            var cardImage = document.getElementById('cardImage');

            var directUrlEl = document.getElementById('directUrl');
            var viewUrlEl = document.getElementById('viewUrl');
            var deleteUrlEl = document.getElementById('deleteUrl');
            var deleteTokenEl = document.getElementById('deleteToken');
            var deleteBtn = document.getElementById('deleteBtn');
            var deleteStatus = document.getElementById('deleteStatus');
            var nextBtn = document.getElementById('nextBtn');

            var maxBytes = 2 * 1024 * 1024;
            var currentFile = null;
            var lastDeleteUrl = null;
            var previewOffsetY = 0; // ใช้ส่งขึ้น server สำหรับครอปภาพจริง

            var zoomSlider = document.getElementById('zoomSlider');
            var rotateLeftBtn = document.getElementById('rotateLeftBtn');
            var rotateRightBtn = document.getElementById('rotateRightBtn');
            var currentZoom = 100;
            var currentRotation = 0;

            function isDebugEnabled() {
                try {
                    return (new URLSearchParams(window.location.search)).get('debug') === '1' || localStorage.getItem('debug') === '1';
                } catch (e) {
                    return false;
                }
            }

            function setDebug(text) {
                if (!debugEl) return;
                if (!isDebugEnabled()) {
                    debugEl.classList.add('hidden');
                    return;
                }
                debugEl.classList.remove('hidden');
                debugEl.textContent = text || '';
            }

            function refreshDebug(reason) {
                var hasPreviewHidden = previewWrap.classList.contains('hidden');
                var fileName = (currentFile && currentFile.name) ? currentFile.name : '';
                var fileSize = (currentFile && currentFile.size) ? String(currentFile.size) : '';
                var previewSrc = preview.getAttribute('src') || '';
                setDebug(
                    'debug=' + (isDebugEnabled() ? '1' : '0') + '\n' +
                    'reason=' + (reason || '') + '\n' +
                    'currentFile=' + fileName + (fileSize ? (' (' + fileSize + ' bytes)') : '') + '\n' +
                    'previewHidden=' + (hasPreviewHidden ? '1' : '0') + '\n' +
                    'previewSrc=' + previewSrc
                );
            }

            function setError(msg) {
                errEl.textContent = msg || '';
            }

            function setStatus(msg) {
                statusEl.textContent = msg || '';
            }

            function resetResult() {
                resultEl.classList.add('hidden');
                directUrlEl.value = '';
                viewUrlEl.value = '';
                deleteUrlEl.value = '';
                deleteTokenEl.value = '';
                deleteStatus.textContent = '';
                lastDeleteUrl = null;
                refreshDebug('resetResult');
            }

            function refreshCard() {
                var t = (titleEl.value || '').trim();
                var d = (descriptionEl.value || '').trim();
                cardTitle.textContent = t || 'Your title';
                cardDesc.textContent = d || 'Your description';
                card.classList.remove('hidden');
                refreshDebug('refreshCard');
            }

            function updateImageTransform() {
                if (!cardImage) return;
                var scale = currentZoom / 100;
                cardImage.style.transform = 'scale(' + scale + ') rotate(' + currentRotation + 'deg)';
            }

            function checkImageRatio(img, cardImgElement) {
                if (!img || !cardImgElement) return;
                img.onload = function () {
                    var ratio = img.naturalWidth / img.naturalHeight;
                    // ถ้ารูปเป็นสี่เหลี่ยมจัตุรัส (ratio ใกล้ 1.0) ให้เพิ่ม class square
                    if (Math.abs(ratio - 1.0) < 0.1) {
                        cardImgElement.classList.add('square');
                    } else {
                        cardImgElement.classList.remove('square');
                    }
                };
            }

            function showPreview(file) {
                previewWrap.classList.remove('hidden');
                var url = URL.createObjectURL(file);
                preview.src = url;
                if (cardImage) {
                    cardImage.src = url;
                    var cardImgEl = cardImage.closest('.cardImg');
                    if (cardImgEl) checkImageRatio(cardImage, cardImgEl);
                }
                refreshCard();
                refreshDebug('showPreview(file)');
            }

            function showUrlPreview(url) {
                previewWrap.classList.remove('hidden');
                preview.src = url;
                if (cardImage) {
                    cardImage.src = url;
                    var cardImgEl = cardImage.closest('.cardImg');
                    if (cardImgEl) checkImageRatio(cardImage, cardImgEl);
                }
                refreshCard();
                refreshDebug('showUrlPreview(url)');
            }

            function handleFile(file) {
                resetResult();
                setError('');
                setStatus('');
                if (!file) {
                    currentFile = null;
                    uploadBtn.disabled = true;
                    previewWrap.classList.add('hidden');
                    preview.src = '';
                    card.classList.add('hidden');
                    refreshDebug('handleFile(null)');
                    return;
                }
                if (file.size > maxBytes) {
                    setError('ไฟล์ใหญ่เกิน 2MB กรุณาเลือกไฟล์ใหม่');
                    currentFile = null;
                    uploadBtn.disabled = true;
                    refreshDebug('handleFile(tooLarge)');
                    return;
                }
                if (!file.type || file.type.indexOf('image/') !== 0) {
                    setError('กรุณาเลือกไฟล์รูปภาพเท่านั้น');
                    currentFile = null;
                    uploadBtn.disabled = true;
                    refreshDebug('handleFile(notImage)');
                    return;
                }
                currentFile = file;
                uploadBtn.disabled = false;
                showPreview(file);
                refreshDebug('handleFile(ok)');
            }

            function buildComposeUrl(imgUrl) {
                var params = new URLSearchParams();
                params.set('img_url', imgUrl);
                return '/compose?' + params.toString();
            }

            titleEl.addEventListener('input', function () {
                if (!card.classList.contains('hidden')) refreshCard();
                refreshDebug('titleEl(input)');
            });

            descriptionEl.addEventListener('input', function () {
                if (!card.classList.contains('hidden')) refreshCard();
                refreshDebug('descriptionEl(input)');
            });

            // ====== Drag to move preview image (vertical) ======
            (function () {
                if (!cardImage) return;

                var dragging = false;
                var startY = 0;
                var currentOffset = 0;

                function applyOffset() {
                    // จำกัดช่วงการเลื่อนไม่ให้เกินไปมาก (หน่วยเป็น px)
                    var min = -200;
                    var max = 200;
                    var clamped = Math.max(min, Math.min(max, currentOffset));
                    currentOffset = clamped;
                    cardImage.style.objectPosition = '50% ' + clamped + 'px';
                    previewOffsetY = clamped;
                }

                cardImage.addEventListener('mousedown', function (e) {
                    dragging = true;
                    startY = e.clientY;
                    cardImage.style.cursor = 'grabbing';
                    e.preventDefault();
                });

                window.addEventListener('mousemove', function (e) {
                    if (!dragging) return;
                    var dy = e.clientY - startY;
                    startY = e.clientY;
                    currentOffset += dy;
                    applyOffset();
                });

                window.addEventListener('mouseup', function () {
                    if (!dragging) return;
                    dragging = false;
                    cardImage.style.cursor = 'grab';
                });

                cardImage.addEventListener('mouseleave', function () {
                    // ป้องกันลากออกนอกกรอบแล้วค้าง
                    dragging = false;
                    cardImage.style.cursor = 'grab';
                });
            })();

            if (zoomSlider) {
                zoomSlider.addEventListener('input', function () {
                    currentZoom = parseInt(this.value, 10) || 100;
                    updateImageTransform();
                });
            }

            if (rotateLeftBtn) {
                rotateLeftBtn.addEventListener('click', function () {
                    currentRotation -= 90;
                    updateImageTransform();
                });
            }

            if (rotateRightBtn) {
                rotateRightBtn.addEventListener('click', function () {
                    currentRotation += 90;
                    updateImageTransform();
                });
            }

            function copyText(value, btn) {
                if (!value) return;
                navigator.clipboard.writeText(value).catch(function () {
                    var t = document.createElement('textarea');
                    t.value = value;
                    document.body.appendChild(t);
                    t.select();
                    document.execCommand('copy');
                    document.body.removeChild(t);
                }).finally(function () {
                    if (!btn) return;
                    var original = btn.textContent;
                    btn.textContent = 'คัดลอกแล้ว';
                    btn.disabled = true;
                    setTimeout(function () {
                        btn.textContent = original;
                        btn.disabled = false;
                    }, 1200);
                });
            }

            document.getElementById('copyDirect').addEventListener('click', function (e) { copyText(directUrlEl.value, e.currentTarget); });
            document.getElementById('copyView').addEventListener('click', function (e) { copyText(viewUrlEl.value, e.currentTarget); });
            document.getElementById('copyDeleteUrl').addEventListener('click', function (e) { copyText(deleteUrlEl.value, e.currentTarget); });
            document.getElementById('copyToken').addEventListener('click', function (e) { copyText(deleteTokenEl.value, e.currentTarget); });

            // Grid Mode handlers
            var modeSingle = document.getElementById('modeSingle');
            var modeGrid = document.getElementById('modeGrid');
            var singleMode = document.getElementById('singleMode');
            var gridMode = document.getElementById('gridMode');
            var dropGrid = document.getElementById('dropGrid');
            var gridFilesInput = document.getElementById('gridFiles');
            var gridPreview = document.getElementById('gridPreview');
            var gridOverlayText = document.getElementById('gridOverlayText');
            var isGridMode = false;
            var gridFilesList = [];

            function switchMode(isGrid) {
                isGridMode = isGrid;
                if (isGrid) {
                    singleMode.classList.add('hidden');
                    gridMode.classList.remove('hidden');
                    modeSingle.style.background = '#fff';
                    modeSingle.style.color = 'var(--text)';
                    modeGrid.style.background = 'var(--primary)';
                    modeGrid.style.color = '#fff';
                } else {
                    singleMode.classList.remove('hidden');
                    gridMode.classList.add('hidden');
                    modeSingle.style.background = 'var(--primary)';
                    modeSingle.style.color = '#fff';
                    modeGrid.style.background = '#fff';
                    modeGrid.style.color = 'var(--text)';
                }
                uploadBtn.disabled = true;
                gridFilesList = [];
                gridPreview.innerHTML = '';
            }

            modeSingle.addEventListener('click', function () { switchMode(false); });
            modeGrid.addEventListener('click', function () { switchMode(true); });

            dropGrid.addEventListener('click', function () { gridFilesInput.click(); });
            gridFilesInput.addEventListener('change', function () {
                var files = Array.from(gridFilesInput.files || []);
                if (files.length < 2) {
                    setError('กรุณาเลือกอย่างน้อย 2 รูป');
                    gridPreview.innerHTML = '';
                    return;
                }
                if (files.length > 5) {
                    setError('เลือกได้สูงสุด 5 รูป');
                    gridPreview.innerHTML = '';
                    return;
                }
                gridFilesList = files;
                gridPreview.innerHTML = '';
                files.forEach(function (file, idx) {
                    if (!file.type || file.type.indexOf('image/') !== 0) return;
                    var img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.style.width = '100%';
                    img.style.height = 'auto';
                    img.style.borderRadius = '8px';
                    img.style.border = '1px solid var(--border)';
                    img.style.objectFit = 'cover';
                    img.style.aspectRatio = '1';
                    gridPreview.appendChild(img);
                });
                uploadBtn.disabled = gridFilesList.length < 2;
                setError('');
            });

            dropGrid.addEventListener('dragenter', function (e) { e.preventDefault(); e.stopPropagation(); dropGrid.classList.add('drag'); });
            dropGrid.addEventListener('dragover', function (e) { e.preventDefault(); e.stopPropagation(); dropGrid.classList.add('drag'); });
            dropGrid.addEventListener('dragleave', function (e) { e.preventDefault(); e.stopPropagation(); dropGrid.classList.remove('drag'); });
            dropGrid.addEventListener('drop', function (e) {
                e.preventDefault();
                e.stopPropagation();
                dropGrid.classList.remove('drag');
                var files = Array.from(e.dataTransfer && e.dataTransfer.files || []);
                var imageFiles = files.filter(function (f) { return f.type && f.type.indexOf('image/') === 0; });
                if (imageFiles.length < 2) {
                    setError('กรุณาลากอย่างน้อย 2 รูป');
                    gridPreview.innerHTML = '';
                    return;
                }
                if (imageFiles.length > 5) {
                    setError('ลากได้สูงสุด 5 รูป');
                    gridPreview.innerHTML = '';
                    return;
                }
                gridFilesList = imageFiles;
                gridFilesInput.value = '';
                gridPreview.innerHTML = '';
                imageFiles.forEach(function (file) {
                    var img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.style.width = '100%';
                    img.style.height = 'auto';
                    img.style.borderRadius = '8px';
                    img.style.border = '1px solid var(--border)';
                    img.style.objectFit = 'cover';
                    img.style.aspectRatio = '1';
                    gridPreview.appendChild(img);
                });
                uploadBtn.disabled = gridFilesList.length < 2;
                setError('');
            });

            drop.addEventListener('click', function () { fileInput.click(); });
            fileInput.addEventListener('change', function () {
                handleFile(fileInput.files && fileInput.files[0]);
                refreshDebug('fileInput(change)');
            });

            drop.addEventListener('dragenter', function (e) { e.preventDefault(); e.stopPropagation(); drop.classList.add('drag'); });
            drop.addEventListener('dragover', function (e) { e.preventDefault(); e.stopPropagation(); drop.classList.add('drag'); });
            drop.addEventListener('dragleave', function (e) { e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag'); });
            drop.addEventListener('drop', function (e) {
                e.preventDefault();
                e.stopPropagation();
                drop.classList.remove('drag');
                var f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
                if (f) {
                    fileInput.value = '';
                    handleFile(f);
                    refreshDebug('drop(drop)');
                }
            });

            uploadBtn.addEventListener('click', function () {
                setError('');
                setStatus('');
                resetResult();

                if (isGridMode) {
                    // Grid Mode
                    if (gridFilesList.length < 2) {
                        setError('กรุณาเลือกอย่างน้อย 2 รูป');
                        return;
                    }
                    var fd = new FormData();
                    gridFilesList.forEach(function (file) {
                        fd.append('files', file);
                    });
                    var overlayText = (gridOverlayText.value || '').trim();
                    if (overlayText) fd.append('overlay_text', overlayText);
                    fd.append('csrf_token', CSRF_TOKEN);

                    uploadBtn.disabled = true;
                    setStatus('กำลังสร้าง Grid Image...');

                    fetch('/api/grid', { method: 'POST', body: fd })
                        .then(function (r) { return r.json().then(function (j) { return { ok: r.ok, status: r.status, body: j }; }); })
                        .then(function (res) {
                            if (!res.ok) {
                                setError((res.body && res.body.error) ? res.body.error : ('Grid creation failed (' + res.status + ')'));
                                setStatus('');
                                uploadBtn.disabled = false;
                                return;
                            }
                            setStatus('สร้าง Grid Image สำเร็จ');

                            var imgUrlForCompose = res.body.direct_url || res.body.view_url || '';
                            if (imgUrlForCompose) {
                                window.location.href = buildComposeUrl(imgUrlForCompose);
                                return;
                            }
                            uploadBtn.disabled = false;
                        })
                        .catch(function () {
                            setError('Grid creation failed');
                            setStatus('');
                            uploadBtn.disabled = false;
                        });
                    return;
                }

                // Single Mode
                if (!currentFile) return;

                var fd = new FormData();
                fd.append('file', currentFile);
                var t = (titleEl.value || '').trim();
                var d = (descriptionEl.value || '').trim();
                if (t) fd.append('title', t);
                if (d) fd.append('description', d);
                var expiry = (expiryEl.value || '').trim();
                if (expiry) fd.append('expiry_minutes', expiry);
                fd.append('offset_y', String(previewOffsetY || 0));
                fd.append('csrf_token', CSRF_TOKEN);

                uploadBtn.disabled = true;
                setStatus('กำลังอัปโหลด...');

                fetch('/api/upload', { method: 'POST', body: fd })
                    .then(function (r) { return r.json().then(function (j) { return { ok: r.ok, status: r.status, body: j }; }); })
                    .then(function (res) {
                        if (!res.ok) {
                            setError((res.body && res.body.error) ? res.body.error : ('Upload failed (' + res.status + ')'));
                            setStatus('');
                            uploadBtn.disabled = false;
                            refreshDebug('upload(resNotOk)');
                            return;
                        }
                        setStatus('อัปโหลดสำเร็จ');

                        // เลือก URL ของไฟล์ภาพจริง (direct_url) สำหรับใช้เป็นพรีวิว + og:image
                        // ถ้าไม่มี direct_url ค่อย fallback ไปใช้ view_url
                        var imgUrlForCompose = res.body.direct_url || res.body.view_url || '';
                        if (imgUrlForCompose) {
                            // ไปหน้า 2 (compose) ทันที ไม่ต้องแสดงลิงก์กลาง
                            window.location.href = buildComposeUrl(imgUrlForCompose);
                            return;
                        }

                        // fallback กรณีไม่มี URL (ไม่ควรเกิด)
                        directUrlEl.value = res.body.direct_url || '';
                        viewUrlEl.value = res.body.view_url || '';
                        deleteUrlEl.value = res.body.delete_url || '';
                        deleteTokenEl.value = res.body.delete_token || '';
                        lastDeleteUrl = res.body.delete_url || null;
                        resultEl.classList.remove('hidden');
                        uploadBtn.disabled = false;
                        refreshDebug('upload(ok,noRedirect)');
                    })
                    .catch(function () {
                        setError('Upload failed');
                        setStatus('');
                        uploadBtn.disabled = false;
                        refreshDebug('upload(catch)');
                    });
            });

            deleteBtn.addEventListener('click', function () {
                deleteStatus.textContent = '';
                if (!lastDeleteUrl) return;
                var token = (deleteTokenEl.value || '').trim();
                if (!token) return;

                var fd = new FormData();
                fd.append('delete_token', token);
                fd.append('csrf_token', CSRF_TOKEN);

                deleteBtn.disabled = true;
                deleteStatus.textContent = 'กำลังลบ...';

                fetch(lastDeleteUrl, { method: 'POST', body: fd })
                    .then(function (r) { return r.json().then(function (j) { return { ok: r.ok, status: r.status, body: j }; }); })
                    .then(function (res) {
                        if (!res.ok) {
                            deleteStatus.textContent = (res.body && res.body.error) ? res.body.error : ('Delete failed (' + res.status + ')');
                            deleteBtn.disabled = false;
                            return;
                        }
                        deleteStatus.textContent = 'ลบสำเร็จ';
                        deleteBtn.disabled = false;
                    })
                    .catch(function () {
                        deleteStatus.textContent = 'Delete failed';
                        deleteBtn.disabled = false;
                    });
            });

            nextBtn.addEventListener('click', function () {
                var v = (directUrlEl.value || '').trim();
                if (!v) return;
                window.location.href = buildComposeUrl(v);
            });

            // ปุ่มแชร์ในหน้า upload (แสดงข้อความแนะนำ)
            var shareBtnsUpload = document.querySelectorAll('.shareBtnUpload');
            shareBtnsUpload.forEach(function (btn) {
                btn.addEventListener('click', function () {
                    alert('กรุณาอัปโหลดรูปและกด "ถัดไป" เพื่อสร้างลิงก์ก่อน แล้วค่อยแชร์');
                });
            });

            refreshDebug('init');
        })();
    </script>
</body>
</html>
